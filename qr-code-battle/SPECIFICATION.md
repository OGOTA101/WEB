# 📱 QR Code Battle: 凸（TOTSU）Web - 仕様書

## 1. 概要

### 1.1 ゲームコンセプト
身の回りのQRコードをスキャンして「軍隊」を生成し、戦わせるリアルタイム戦術シミュレーションゲーム。
「信長の野望」の戦術パートを抜き出したような戦闘システムと、「バーコードバトラー」のワクワク感を融合。
ユニットは全て「凸」という記号だけで表現するミニマルなビジュアルが特徴。

### 1.2 ゲームの特徴
- **QR生成**: QRコードをスキャンして軍隊を生成
- **再現性保証**: 同じコードからは世界中どこでも同じ能力の軍隊が生成される
- **4部隊デッキ**: 手持ちから4つを選んで戦場へ
- **リアルタイム戦術**: タップで指示を出し、凸の軍勢を操る
- **シングル＆マルチ対応**: 一人でもフレンドとも遊べる

### 1.3 プラットフォーム
| 項目 | 詳細 |
|------|------|
| 対応ブラウザ | Chrome, Firefox, Edge, Safari（モバイル対応） |
| 対応デバイス | スマートフォン（縦持ち推奨）、タブレット、PC |
| 画面比率 | **9:16** 固定（PC等では左右に黒帯を表示して比率を維持） |
| 通信 | WebSocket (Socket.io) / Firebase Realtime Database（マルチプレイ時） |
| ホスティング | Firebase Hosting |
| QR解析 | html5-qrcode.js ライブラリ |

---

## 2. 世界観・ストーリー

### 2.1 設定
「凸（トツ）」——それは古代から戦場を象徴してきた記号。
プレイヤーは「凸令官（とつれいかん）」となり、身の回りに眠る「商品の魂」を呼び覚まし、凸の軍勢として戦場に送り込む。
敵は同じく凸を操る別の令官。先に相手の全軍を壊滅させた者が勝利する！

---

## 3. ユニット生成システム

### 3.1 生成方法
以下の2種類の方法でユニットを生成できる。UIはシンプル化され、誤操作を防ぐ設計となっている。

1. **人材発掘（コインガチャ）**
   - **コスト**: 100コイン / 1回
   - **獲得**: ステージクリアや対戦報酬でコインを入手。
   - **仕組み**: ランダムなシード値を内部生成。
   - **特徴**: 完全ランダム生成。手軽に戦力を増強できる。

2. **QR画像読み込み（ファイルスキャン）**
   - **コスト**: **無料**（回数無制限）
   - **仕組み**: 保存されたQRコード画像をアップロードし、その内容をシードとして生成。
   - **特徴**: 同じ画像からは必ず同じユニットが生まれる（再現性あり）。カメラ起動によるトラブルを回避し、安全で確実な読み込みを採用。

### 3.2 コストとレアリティ
ユニットの強さ（総合コスト）は確率によって決定される。

| レアリティ | 範囲 | 出現率 | 演出 |
|-----------|------|-------|------|
| **並 (Normal)** | 3,000〜4,000 pt | 40% | 白 |
| **良 (Rare)** | 4,001〜6,000 pt | 40% | 青 |
| **激強 (Super Rare)** | 6,001〜8,000 pt | 15% | 紫 |
| **神 (Legend)** | 8,001〜10,000 pt | 5% | 金 |

### 3.3 デッキ編成ルール
- 最大4部隊まで編成可能。
- **制限事項**: **同一ユニット（同じID）は1体しか編成できない。**

---

## 4. ユニットパラメータ詳細

### 4.1 ステータス定義
| パラメータ | 略称 | 意味 |
|-----------|------|------|
| 兵力 | HP | 耐久力。0になると消滅。 |
| 攻撃 | ATK | 敵HPを削る速度。 |
| 防御 | DEF | ダメージ軽減。最低保証ダメージは **1**。 |
| 射程 | RNG | 攻撃可能距離。物理接触時は必ず攻撃可能（最低射程保証あり）。 |
| 機動 | SPD | 移動速度。 |

---

## 5. ユニットクラス（兵種）システム

### 5.1 クラス判定ロジック
パラメータの偏りによってクラスが決定される。

| クラス | 判定条件 | 特徴 |
|--------|---------|------|
| **歩兵** | バランス型 | 万能。HP回復スキル持ち。 |
| **騎兵** | SPD が最大 | 高速移動。遠距離に強い。神速スキル。 |
| **重装** | DEF が最大 | 高耐久。騎兵に強い。鉄壁スキル。 |
| **遠距離** | RNG が最大 | 遠くから攻撃。重装に強い。千里眼スキル。 |
| **特殊(忍)** | ATK が最大 | 超火力・紙装甲。クリティカル攻撃スキル。 |

### 5.2 クラス相性
3すくみ＋特殊という構成。相性有利時はダメージが増加。

```
      騎馬 ──(有利)───▶ 遠距離
       ▲                  │
       │                  │
    (有利)             (有利)
       │                  │
       │                  ▼
     歩兵 ◀──(有利)─── 重装

       忍（特殊）：全てに対して攻撃的有利、守備的不利
```

---

## 6. 戦闘システム（最新仕様）

### 6.1 基本ルール
| 項目 | 内容 |
|------|------|
| 勝利条件 | 敵全部隊の兵力を0にする |
| 敗北条件 | 味方全部隊の兵力を0にする |
| 出撃 | バトル開始時に自分・敵の全ユニット（最大4vs4）がフィールドに出撃状態で開始。 |

### 6.2 ゲームモード
| モード | 内容 |
|--------|------|
| **天下統一** | CPUとの勝ち抜き戦。全10ステージ。ステージ10クリア後に高難易度「裏ステージ（11〜20）」解放。裏ステージは敵戦力が大幅強化(+4000)されている。 |
| **通信対戦(PvP)** | リアルタイムオンライン対戦。ランダムマッチ／合言葉マッチ。勝利報酬: **1000G**。 |

### 6.3 操作・機能
| 機能 | 詳細 |
|------|------|
| **移動指示** | ユニットをタップ→マップ地点をタップで移動。敵をタップで追跡。 |
| **オート攻撃** | 射程内に入ると自動で攻撃開始。 |
| **スキル** | ユニット選択時、画面下部のボタンで発動（1戦闘1回）。 |
| **AUTO Mode** | **ON/OFF切替可**。ONにするとAIが全ユニットを操作し、最寄りの敵へ進軍・攻撃させる。放置プレイやPvP時の代行として機能。 |
| **一時停止** | 画面左上のPauseボタン。バトルの進行を停止。再開可能。降参する場合はボタンから選択。 |

### 6.4 バトルメカニクス詳細
*   **物理挙動**: ユニット同士は重さを持ち、衝突すると押し合う。
*   **最低射程保証**: 射程ステータスが低い場合でも、ユニットが物理的に接触（サイズ+10px）していれば必ず攻撃可能。
*   **バランス調整**: 
    *   防御力の価値を高めるため、最低保証ダメージを `1` に設定。
    *   射程距離の全体係数を `1/4` に縮小し、より接近戦が発生しやすく調整。
    *   ステージ難易度を全体的に強化（v1.2時点）。
*   **アスペクト比保護**: どのデバイスでも `9:16` の比率を維持。横長画面では黒帯が入る。
*   **ユニット表示（ビジュアル）**:
    *   **形状**: 将棋の駒のような「凸」型の多角形を描画（文字ではなく図形）。
    *   **識別**: 図形の中心に兵種を表す一文字（歩、騎、重、弓、忍）を表示。
    *   **味方配色**: **白塗りつぶし**、青枠、黒文字。
    *   **敵方配色**: **黒塗りつぶし**、白枠、白文字。
    *   このデザインはインゲーム、編成画面、ストック画面すべてで統一されている。

---

## 7. 画面フロー

1. **タイトル画面**: モード選択（天下統一 / 通信対戦 / 編成 / スキャン）。BGM: `yowanotsuki_karakasa.mp3`
2. **スキャン画面**:
   - ガチャ（コイン消費）
   - QR画像読み込み（無料）
3. **編成画面**:
   - ストック一覧からドラッグ＆ドロップでデッキ編成
   - ユニットアイコンはSVGによる凸型図形表示
4. **ステージ選択**: 
   - 通常ステージ（1-10）
   - ハードステージ（11-20、条件解放）
5. **バトル画面**:
   - BGM: `yowanotsukli_koujou.mp3`
   - 上部：敵軍情報
   - 中央：戦場（9:16）
   - 下部：自軍情報、スキルボタン、AUTOボタン
   - 最下部フッター：BGM/SE設定
6. **リザルト画面**: 勝利/敗北判定。報酬獲得。
   - PvP勝利報酬: **1000G**
   - ハードモード報酬: **600G**
   - 通常ステージ報酬: 基礎点 + ボーナス

---

## 8. 技術スタック & サウンド

### 8.1 技術
- **HTML5 / JavaScript (ES6+)**: フレームワークなしのVanilla JS構成。
- **Web Audio API**: BGM再生・切り替え、SE制御。
- **Canvas API**: 高リフレッシュレートでの描画。パス描画によるユニット生成。
- **Firebase**: 
    - **Hosting**: アプリ配信。
    - **Realtime Database**: マッチング、対戦同期。

### 8.2 サウンド
- **BGM**: ファイル読み込み方式。
    - タイトル/アウトゲーム: `yowanotsuki_karakasa.mp3`
    - バトル: `yowanotsukli_koujou.mp3`
    - 画面遷移時に自動フェード/切り替え。
- **SE**: 攻撃、撃破、UI操作音、勝利/敗北ジングルなどを再生。
- **制御**: バトル終了時に即座にサウンド停止、リソース解放を行う。

---

## 9. 更新履歴

### v1.2.1 (Current)
- **ユニット表示の刷新**: 
    - 文字の「凸」を廃止し、Canvasパス/SVGによる正確な凸型図形描画へ変更。
    - 塗りつぶしによる敵味方の明確な区別（白vs黒）。
    - 視認性を高めるため、クラス文字を図形内に配置。
- **サウンド実装の強化**:
    - BGMファイルの定数化とシーン連動切り替え。
    - ゲーム終了時のSEループバグ修正（BattleSystemの破棄プロセス確立）。
- **ゲームモード拡張**:
    - ハードモード（裏ステージ）の実装。敵戦力大幅アップ。
    - PvP報酬の増額（1000G）。

### v1.2.0
- **オンライン対戦実装**: ランダムマッチ、合言葉マッチの実装。
- **画面比率固定**: PC/スマホ問わず9:16を維持するレンダラー改修。
- **スキャンUI刷新**: カメラ・手動入力を廃止し、ガチャと画像読込に一本化。
- **AUTOモード実装**: プレイヤーもAIに操作を委任可能に。
- **バランス調整**: 最低ダメージ1、射程係数0.025に変更。

### v1.0.0
- 初版リリース
- 基本的なバトルシステム、QR生成、ステージ進行の実装。
