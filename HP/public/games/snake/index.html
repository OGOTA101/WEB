<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç „Çπ„Éç„Éº„ÇØ„Ç≤„Éº„É† - SGGameSite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f6f6f6;
            color: #000;
            font-size: 14px;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
        }

        .header {
            background: #316AC5;
            color: white;
            padding: 8px 0;
            border-bottom: 2px solid #0066cc;
        }

        .header-content {
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .header .tagline {
            font-size: 11px;
            color: #cce0ff;
        }

        .breadcrumb {
            background: #e6f0ff;
            padding: 8px 15px;
            border-bottom: 1px solid #ccc;
            font-size: 13px;
        }

        .breadcrumb a {
            color: #0066cc;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .game-container {
            padding: 20px;
            text-align: center;
        }

        .game-title {
            font-size: 24px;
            color: #316AC5;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .game-info {
            background: #ffffcc;
            border: 1px solid #ffcc00;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .game-info h3 {
            color: #cc6600;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .controls-info {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .controls-info h4 {
            color: #316AC5;
            margin-bottom: 10px;
        }

        .game-board {
            display: inline-block;
            background: #000;
            border: 3px solid #316AC5;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            touch-action: none;
        }

        .game-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #e6f0ff;
            border: 1px solid #ccc;
            padding: 10px 20px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #316AC5;
        }

        .game-buttons {
            margin-bottom: 20px;
        }

        .btn {
            background: #316AC5;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #4a90e2;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .game-over {
            background: #ffeeee;
            border: 2px solid #ff0000;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            max-width: 400px;
            display: none;
        }

        .game-over h3 {
            color: #ff0000;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .high-score {
            background: #eeffee;
            border: 2px solid #00aa00;
            padding: 15px;
            margin: 20px auto;
            border-radius: 10px;
            max-width: 400px;
        }

        .high-score h4 {
            color: #00aa00;
            margin-bottom: 10px;
        }

        .back-link {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }

        .back-link a {
            color: #0066cc;
            text-decoration: none;
            font-size: 14px;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .mobile-controls {
            display: none;
            margin-top: 20px;
            gap: 10px;
            justify-content: center;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            max-width: 200px;
            margin-left: auto;
            margin-right: auto;
        }

        .mobile-btn {
            background: #316AC5;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            min-width: 50px;
            min-height: 50px;
            touch-action: manipulation;
        }

        .mobile-btn:active {
            background: #4a90e2;
        }

        .food-legend {
            background: #f0f8ff;
            border: 1px solid #4a90e2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .food-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .food-icon {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }

            .game-stats {
                gap: 15px;
            }

            .mobile-controls {
                display: grid;
            }

            .game-board {
                max-width: 100%;
                border-width: 2px;
            }

            #gameCanvas {
                max-width: 100%;
                height: auto;
            }

            .food-legend {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .game-stats {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                margin: 5px;
                padding: 10px 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="header">
            <div class="header-content">
                <h1>üéÆ SGGameSite</h1>
                <div class="tagline">Yahoo! GamesÈ¢®„É¨„Éà„É≠„Ç≤„Éº„É†„Çµ„Ç§„Éà</div>
            </div>
        </div>

        <!-- „Éë„É≥„Åè„Åö„Éä„Éì -->
        <div class="breadcrumb">
            <a href="../../index.html">„Éõ„Éº„É†</a> > <a href="../../index.html#games">„Ç≤„Éº„É†</a> > „Çπ„Éç„Éº„ÇØ„Ç≤„Éº„É†
        </div>

        <!-- „Ç≤„Éº„É†„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="game-container">
            <div class="game-title">üêç „Çπ„Éç„Éº„ÇØ„Ç≤„Éº„É† Enhanced</div>

            <div class="game-info">
                <h3>üéØ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ</h3>
                <p>Ëõá„ÇíÊìç‰Ωú„Åó„Å¶Êßò„ÄÖ„Å™È£ü„ÅπÁâ©„ÇíÈ£ü„Åπ„ÄÅ„Åß„Åç„Çã„Å†„ÅëÈï∑„ÅèÊàêÈï∑„Åï„Åõ„Çà„ÅÜÔºÅ</p>
                <p>Â£Å„ÇÑËá™ÂàÜ„ÅÆ‰Ωì„Å´„Å∂„Å§„Åã„Çã„Å®„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Åß„Åô„ÄÇ</p>
            </div>

            <!-- È£ü„ÅπÁâ©„ÅÆË™¨Êòé -->
            <div class="food-legend">
                <div class="food-item">
                    <span class="food-icon">üçé</span>
                    <span>„Çä„Çì„Åî (+10ÁÇπ)</span>
                </div>
                <div class="food-item">
                    <span class="food-icon">üçå</span>
                    <span>„Éê„Éä„Éä (+15ÁÇπ)</span>
                </div>
                <div class="food-item">
                    <span class="food-icon">üçá</span>
                    <span>„Å∂„Å©„ÅÜ (+20ÁÇπ)</span>
                </div>
                <div class="food-item">
                    <span class="food-icon">üçì</span>
                    <span>„ÅÑ„Å°„Åî (+25ÁÇπ)</span>
                </div>
                <div class="food-item">
                    <span class="food-icon">ü•á</span>
                    <span>ÁâπÂà•Ë≥û (+100ÁÇπ, 4„Éû„ÇπÂàÜ)</span>
                </div>
            </div>

            <div class="controls-info">
                <h4>üïπÔ∏è Êìç‰ΩúÊñπÊ≥ï</h4>
                <p><strong>PC:</strong> Áü¢Âç∞„Ç≠„ÉºÔºà‚Üë‚Üì‚Üê‚ÜíÔºâ„Åæ„Åü„ÅØWASD</p>
                <p><strong>„Çπ„Éû„Éõ:</strong> ÁîªÈù¢„Çπ„ÉØ„Ç§„Éó„Åæ„Åü„ÅØÊñπÂêë„Éú„Çø„É≥</p>
            </div>

            <!-- „Ç≤„Éº„É†Áµ±Ë®à -->
            <div class="game-stats">
                <div class="stat-item">
                    <div class="stat-label">„Çπ„Ç≥„Ç¢</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Èï∑„Åï</div>
                    <div class="stat-value" id="length">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÊúÄÈ´ò„Çπ„Ç≥„Ç¢</div>
                    <div class="stat-value" id="highScore">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÁâπÂà•Ë≥û</div>
                    <div class="stat-value" id="bonusCount">0</div>
                </div>
            </div>

            <!-- „Ç≤„Éº„É†„Éú„Çø„É≥ -->
            <div class="game-buttons">
                <button class="btn" id="startBtn" onclick="startGame()">„Ç≤„Éº„É†ÈñãÂßã</button>
                <button class="btn" id="pauseBtn" onclick="pauseGame()" disabled>‰∏ÄÊôÇÂÅúÊ≠¢</button>
                <button class="btn" id="resetBtn" onclick="resetGame()">„É™„Çª„ÉÉ„Éà</button>
            </div>

            <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
            <div class="game-board">
                <canvas id="gameCanvas" width="600" height="600"></canvas>
            </div>

            <!-- „É¢„Éê„Ç§„É´Áî®„Ç≥„É≥„Éà„É≠„Éº„É´ -->
            <div class="mobile-controls">
                <div style="grid-column: 2;">
                    <button class="mobile-btn" onclick="changeDirection('UP')">‚Üë</button>
                </div>
                <div style="grid-row: 2;">
                    <button class="mobile-btn" onclick="changeDirection('LEFT')">‚Üê</button>
                </div>
                <div style="grid-row: 2; grid-column: 2;">
                    <button class="mobile-btn" onclick="changeDirection('DOWN')">‚Üì</button>
                </div>
                <div style="grid-row: 2; grid-column: 3;">
                    <button class="mobile-btn" onclick="changeDirection('RIGHT')">‚Üí</button>
                </div>
            </div>

            <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºË°®Á§∫ -->
            <div class="game-over" id="gameOver">
                <h3>üö´ „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ</h3>
                <p>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore">0</span></p>
                <p>Ëõá„ÅÆÈï∑„Åï: <span id="finalLength">1</span></p>
                <p>ÁâπÂà•Ë≥ûÁç≤Âæó: <span id="finalBonus">0</span>ÂÄã</p>
                <button class="btn" onclick="resetGame()" style="margin-top: 15px;">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
            </div>

            <!-- „Éè„Ç§„Çπ„Ç≥„Ç¢Ë°®Á§∫ -->
            <div class="high-score">
                <h4>üèÜ ‰ªäÂõû„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥ÊúÄÈ´òË®òÈå≤</h4>
                <p>„Çπ„Ç≥„Ç¢: <span id="sessionHigh">0</span> | Èï∑„Åï: <span id="sessionLength">1</span> | ÁâπÂà•Ë≥û: <span
                        id="sessionBonus">0</span>ÂÄã</p>
            </div>

            <!-- Êàª„Çã„É™„É≥„ÇØ -->
            <div class="back-link">
                <a href="../../index.html">‚Üê „Ç≤„Éº„É†‰∏ÄË¶ß„Å´Êàª„Çã</a>
            </div>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†Â§âÊï∞
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const canvasSize = 600;

        let snake = [{ x: 300, y: 300 }];
        let direction = { x: 0, y: 0 };
        let foods = [];
        let score = 0;
        let bonusCount = 0;
        let gameRunning = false;
        let gameLoop = null;
        let isPaused = false;

        // „Çø„ÉÉ„ÉÅ/„Çπ„ÉØ„Ç§„ÉóÈñ¢ÈÄ£Â§âÊï∞
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        // ÁîªÂÉè„É™„ÇΩ„Éº„Çπ
        const fruitImages = {};
        let imagesLoaded = 0;
        const totalImages = 5;

        // È£ü„ÅπÁâ©„ÅÆÁ®ÆÈ°û
        const foodTypes = [
            { emoji: 'üçé', points: 10, color: '#ff0000', weight: 40, image: 'apple' },
            { emoji: 'üçå', points: 15, color: '#ffff00', weight: 30, image: 'banana' },
            { emoji: 'üçá', points: 20, color: '#800080', weight: 20, image: 'grape' },
            { emoji: 'üçì', points: 25, color: '#ff69b4', weight: 10, image: 'strawberry' }
        ];

        const specialFood = { emoji: 'ü•á', points: 100, color: '#ffd700', size: 2, image: 'special' };

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Éè„Ç§„Çπ„Ç≥„Ç¢„ÇíË™≠„ÅøËæº„Åø
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let sessionHighScore = 0;
        let sessionHighLength = 1;
        let sessionHighBonus = 0;

        // ÁîªÂÉèË™≠„ÅøËæº„Åø
        function loadImages() {
            const imageNames = ['apple', 'banana', 'grape', 'strawberry', 'special'];

            imageNames.forEach(name => {
                const img = new Image();
                img.onload = () => {
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        // ÂÖ®„Å¶„ÅÆÁîªÂÉè„ÅåË™≠„ÅøËæº„Åæ„Çå„Åü„ÇâÂàùÊúüÂåñÂÆå‰∫Ü
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').textContent = '„Ç≤„Éº„É†ÈñãÂßã';
                    }
                };
                img.onerror = () => {
                    console.warn(`Failed to load image: ${name}.svg`);
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').textContent = '„Ç≤„Éº„É†ÈñãÂßã';
                    }
                };
                img.src = `assets/images/${name}.svg`;
                fruitImages[name] = img;
            });
        }

        // ÂàùÊúüÂåñ
        function init() {
            document.getElementById('highScore').textContent = highScore;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'ÁîªÂÉèË™≠„ÅøËæº„Åø‰∏≠...';

            // ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø
            loadImages();

            generateFood();
            drawGame();

            // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„ÉàÔºà„Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢‰ªò„ÅçÔºâ
            document.addEventListener('keydown', handleKeyPress);

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„Çπ„ÉØ„Ç§„ÉóÂØæÂøúÔºâ
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });

            // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„Çí„É¨„Çπ„Éù„É≥„Ç∑„Éñ„Å´Ë™øÊï¥
            adjustCanvasSize();
            window.addEventListener('resize', adjustCanvasSize);
        }

        // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë™øÊï¥
        function adjustCanvasSize() {
            const container = document.querySelector('.game-container');
            const containerWidth = container.clientWidth - 40;

            if (containerWidth < 600) {
                const scale = containerWidth / 600;
                canvas.style.width = (containerWidth - 20) + 'px';
                canvas.style.height = (containerWidth - 20) + 'px';
            } else {
                canvas.style.width = '600px';
                canvas.style.height = '600px';
            }
        }

        // „Çø„ÉÉ„ÉÅ„Çπ„Çø„Éº„ÉàÂá¶ÁêÜ
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
        }

        // „Çø„ÉÉ„ÉÅ„Ç®„É≥„ÉâÂá¶ÁêÜÔºà„Çπ„ÉØ„Ç§„ÉóÂà§ÂÆöÔºâ
        function handleTouchEnd(e) {
            e.preventDefault();
            if (!gameRunning || isPaused) return;

            const touch = e.changedTouches[0];
            touchEndX = touch.clientX;
            touchEndY = touch.clientY;

            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const minSwipeDistance = 30;

            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Ê®™ÊñπÂêë„ÅÆ„Çπ„ÉØ„Ç§„Éó
                if (Math.abs(deltaX) > minSwipeDistance) {
                    if (deltaX > 0 && direction.x === 0) {
                        direction = { x: gridSize, y: 0 }; // Âè≥
                    } else if (deltaX < 0 && direction.x === 0) {
                        direction = { x: -gridSize, y: 0 }; // Â∑¶
                    }
                }
            } else {
                // Á∏¶ÊñπÂêë„ÅÆ„Çπ„ÉØ„Ç§„Éó
                if (Math.abs(deltaY) > minSwipeDistance) {
                    if (deltaY > 0 && direction.y === 0) {
                        direction = { x: 0, y: gridSize }; // ‰∏ã
                    } else if (deltaY < 0 && direction.y === 0) {
                        direction = { x: 0, y: -gridSize }; // ‰∏ä
                    }
                }
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            if (!gameRunning) {
                gameRunning = true;
                isPaused = false;
                direction = { x: gridSize, y: 0 }; // Âè≥Âêë„Åç„Åß„Çπ„Çø„Éº„Éà

                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('gameOver').style.display = 'none';

                gameLoop = setInterval(updateGame, 100); // Â∞ë„ÅóÈÄü„Åè„Åó„Åü
            }
        }

        // „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢/ÂÜçÈñã
        function pauseGame() {
            if (gameRunning) {
                if (isPaused) {
                    gameLoop = setInterval(updateGame, 100);
                    document.getElementById('pauseBtn').textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
                    isPaused = false;
                } else {
                    clearInterval(gameLoop);
                    document.getElementById('pauseBtn').textContent = 'ÂÜçÈñã';
                    isPaused = true;
                }
            }
        }

        // „Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetGame() {
            gameRunning = false;
            isPaused = false;
            clearInterval(gameLoop);

            snake = [{ x: 300, y: 300 }];
            direction = { x: 0, y: 0 };
            score = 0;
            bonusCount = 0;
            foods = [];

            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
            document.getElementById('gameOver').style.display = 'none';

            updateScore();
            generateFood();
            drawGame();
        }

        // È£ü„ÅπÁâ©ÁîüÊàêÔºàË§áÊï∞Á®ÆÈ°ûÔºâ
        function generateFood() {
            // ÈÄöÂ∏∏„ÅÆÈ£ü„ÅπÁâ©„Çí1-3ÂÄãÁîüÊàê
            const normalFoodCount = Math.floor(Math.random() * 3) + 1;

            for (let i = 0; i < normalFoodCount; i++) {
                let newFood;
                let attempts = 0;

                do {
                    const randomValue = Math.random() * 100;
                    let selectedType = foodTypes[0];
                    let cumulative = 0;

                    for (const type of foodTypes) {
                        cumulative += type.weight;
                        if (randomValue <= cumulative) {
                            selectedType = type;
                            break;
                        }
                    }

                    newFood = {
                        x: Math.floor(Math.random() * (canvasSize / gridSize)) * gridSize,
                        y: Math.floor(Math.random() * (canvasSize / gridSize)) * gridSize,
                        type: selectedType,
                        size: 1
                    };
                    attempts++;
                } while ((isPositionOccupied(newFood.x, newFood.y) || isPositionInFoods(newFood.x, newFood.y)) && attempts < 50);

                if (attempts < 50) {
                    foods.push(newFood);
                }
            }

            // 5%„ÅÆÁ¢∫Áéá„ÅßÁâπÂà•„Å™È£ü„ÅπÁâ©„ÇíÁîüÊàê
            if (Math.random() < 0.05) {
                let specialFoodItem;
                let attempts = 0;

                do {
                    specialFoodItem = {
                        x: Math.floor(Math.random() * ((canvasSize / gridSize) - 1)) * gridSize,
                        y: Math.floor(Math.random() * ((canvasSize / gridSize) - 1)) * gridSize,
                        type: specialFood,
                        size: 2
                    };
                    attempts++;
                } while ((isSpecialPositionOccupied(specialFoodItem.x, specialFoodItem.y) || isSpecialPositionInFoods(specialFoodItem.x, specialFoodItem.y)) && attempts < 50);

                if (attempts < 50) {
                    foods.push(specialFoodItem);
                }
            }
        }

        // ‰ΩçÁΩÆ„ÅåÂç†Êúâ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isPositionOccupied(x, y) {
            return snake.some(segment => segment.x === x && segment.y === y);
        }

        function isPositionInFoods(x, y) {
            return foods.some(food => food.x === x && food.y === y);
        }

        function isSpecialPositionOccupied(x, y) {
            for (let dx = 0; dx < 2; dx++) {
                for (let dy = 0; dy < 2; dy++) {
                    if (snake.some(segment => segment.x === x + dx * gridSize && segment.y === y + dy * gridSize)) {
                        return true;
                    }
                }
            }
            return false;
        }

        function isSpecialPositionInFoods(x, y) {
            for (let dx = 0; dx < 2; dx++) {
                for (let dy = 0; dy < 2; dy++) {
                    if (foods.some(food => food.x === x + dx * gridSize && food.y === y + dy * gridSize)) {
                        return true;
                    }
                }
            }
            return false;
        }

        // „Ç≤„Éº„É†Êõ¥Êñ∞
        function updateGame() {
            if (!gameRunning || isPaused) return;

            // Ëõá„ÅÆÈ†≠„ÅÆÊñ∞„Åó„ÅÑ‰ΩçÁΩÆ
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // Â£Å„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
            if (head.x < 0 || head.x >= canvasSize || head.y < 0 || head.y >= canvasSize) {
                gameOver();
                return;
            }

            // Ëá™ÂàÜ„ÅÆ‰Ωì„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
            if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                gameOver();
                return;
            }

            snake.unshift(head);

            // È£ü„ÅπÁâ©„ÇíÈ£ü„Åπ„Åü„ÅãÂà§ÂÆö
            let foodEaten = false;
            for (let i = foods.length - 1; i >= 0; i--) {
                const food = foods[i];
                let eaten = false;

                if (food.size === 1) {
                    // ÈÄöÂ∏∏„Çµ„Ç§„Ç∫„ÅÆÈ£ü„ÅπÁâ©
                    if (head.x === food.x && head.y === food.y) {
                        eaten = true;
                    }
                } else {
                    // ÁâπÂà•„Å™Â§ß„Åç„ÅÑÈ£ü„ÅπÁâ©Ôºà2x2Ôºâ
                    for (let dx = 0; dx < 2; dx++) {
                        for (let dy = 0; dy < 2; dy++) {
                            if (head.x === food.x + dx * gridSize && head.y === food.y + dy * gridSize) {
                                eaten = true;
                                break;
                            }
                        }
                        if (eaten) break;
                    }
                }

                if (eaten) {
                    score += food.type.points;
                    if (food.type === specialFood) {
                        bonusCount++;
                    }
                    foods.splice(i, 1);
                    foodEaten = true;
                    updateScore();

                    // È£ü„ÅπÁâ©„Åå„Å™„Åè„Å™„Å£„Åü„ÇâÊñ∞„Åó„ÅèÁîüÊàê
                    if (foods.length === 0) {
                        generateFood();
                    }
                    break;
                }
            }

            if (!foodEaten) {
                snake.pop();
            }

            drawGame();
        }

        // „Ç≤„Éº„É†ÊèèÁîª
        function drawGame() {
            // ËÉåÊôØ„Çí„ÇØ„É™„Ç¢
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvasSize, canvasSize);

            // „Ç∞„É™„ÉÉ„ÉâÁ∑ö„ÇíÊèèÁîªÔºàËñÑ„ÅèÔºâ
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= canvasSize; i += gridSize) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvasSize);
                ctx.moveTo(0, i);
                ctx.lineTo(canvasSize, i);
                ctx.stroke();
            }

            // Ëõá„ÇíÊèèÁîª
            snake.forEach((segment, index) => {
                ctx.save();

                if (index === 0) {
                    // È†≠ÈÉ®ÔºàÊòé„Çã„ÅÑÁ∑ë„ÅßÁ´ã‰ΩìÊÑü„ÇíÊºîÂá∫Ôºâ
                    const gradient = ctx.createRadialGradient(
                        segment.x + gridSize / 2, segment.y + gridSize / 2, 0,
                        segment.x + gridSize / 2, segment.y + gridSize / 2, gridSize / 2
                    );
                    gradient.addColorStop(0, '#44ff44');
                    gradient.addColorStop(1, '#00dd00');
                    ctx.fillStyle = gradient;

                    // ‰∏∏„Åø„ÇíÂ∏Ø„Å≥„ÅüÈ†≠ÈÉ®
                    ctx.beginPath();
                    ctx.roundRect(segment.x + 1, segment.y + 1, gridSize - 2, gridSize - 2, 4);
                    ctx.fill();

                    // ÁõÆ„ÇíÊèèÁîª
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(segment.x + 6, segment.y + 6, 2, 0, Math.PI * 2);
                    ctx.arc(segment.x + 14, segment.y + 6, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // ÁõÆ„ÅÆÁôΩ„ÅÑÈÉ®ÂàÜ
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(segment.x + 7, segment.y + 5, 1, 0, Math.PI * 2);
                    ctx.arc(segment.x + 15, segment.y + 5, 1, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // ‰ΩìÈÉ®ÔºàÁ∑ë„Åã„ÇâÁôΩ„Å∏„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÄÅË¶ã„ÇÑ„Åô„ÅïÈáçË¶ñÔºâ
                    const bodyProgress = Math.min(index / snake.length, 0.8); // ÊúÄÂ§ß80%„Åæ„ÅßÁôΩ„Åè„Åô„Çã

                    // Á∑ë„ÅÆÊàêÂàÜ„Çí‰øù„Å°„Å§„Å§ÁôΩ„ÇíÊ∑∑„Åú„Çã
                    const greenComponent = Math.floor(200 - (bodyProgress * 80)); // 200 ‚Üí 120
                    const redComponent = Math.floor(bodyProgress * 180); // 0 ‚Üí 180
                    const blueComponent = Math.floor(bodyProgress * 180); // 0 ‚Üí 180

                    const gradient = ctx.createRadialGradient(
                        segment.x + gridSize / 2, segment.y + gridSize / 2, 2,
                        segment.x + gridSize / 2, segment.y + gridSize / 2, gridSize / 2
                    );
                    gradient.addColorStop(0, `rgb(${redComponent + 20}, ${greenComponent + 20}, ${blueComponent + 20})`);
                    gradient.addColorStop(1, `rgb(${redComponent}, ${greenComponent}, ${blueComponent})`);
                    ctx.fillStyle = gradient;

                    ctx.beginPath();
                    ctx.roundRect(segment.x + 2, segment.y + 2, gridSize - 4, gridSize - 4, 2);
                    ctx.fill();

                    // ‰Ωì„ÅÆËº™ÈÉ≠„ÇíÂ∞ë„ÅóÂº∑Ë™ø
                    ctx.strokeStyle = `rgba(0, ${Math.floor(greenComponent * 0.7)}, 0, 0.8)`;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }

                ctx.restore();
            });

            // È£ü„ÅπÁâ©„ÇíÊèèÁîª
            foods.forEach(food => {
                ctx.save();

                if (food.size === 1) {
                    // ÈÄöÂ∏∏„Çµ„Ç§„Ç∫„ÅÆÈ£ü„ÅπÁâ©
                    drawNormalFood(food);
                } else {
                    // ÁâπÂà•„Å™Â§ß„Åç„ÅÑÈ£ü„ÅπÁâ©
                    drawSpecialFood(food);
                }

                ctx.restore();
            });
        }

        // ÈÄöÂ∏∏„ÅÆÈ£ü„ÅπÁâ©ÊèèÁîª
        function drawNormalFood(food) {
            const img = fruitImages[food.type.image];
            if (img && img.complete) {
                // SVGÁîªÂÉè„ÇíÊèèÁîª
                ctx.drawImage(img, food.x, food.y, gridSize, gridSize);
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂæìÊù•„ÅÆÊèèÁîªÊñπÊ≥ï
                const centerX = food.x + gridSize / 2;
                const centerY = food.y + gridSize / 2;
                switch (food.type.emoji) {
                    case 'üçé':
                        drawApple(centerX, centerY, gridSize / 2 - 2);
                        break;
                    case 'üçå':
                        drawBanana(centerX, centerY, gridSize / 2 - 2);
                        break;
                    case 'üçá':
                        drawGrape(centerX, centerY, gridSize / 2 - 2);
                        break;
                    case 'üçì':
                        drawStrawberry(centerX, centerY, gridSize / 2 - 2);
                        break;
                }
            }
        }

        // ÁâπÂà•„Å™È£ü„ÅπÁâ©ÊèèÁîªÔºà2x2„Éû„ÇπÔºâ
        function drawSpecialFood(food) {
            const img = fruitImages[food.type.image];
            if (img && img.complete) {
                // SVGÁîªÂÉè„ÇíÊèèÁîªÔºà2x2„Éû„ÇπÔºâ
                ctx.drawImage(img, food.x, food.y, gridSize * 2, gridSize * 2);
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂæìÊù•„ÅÆÊèèÁîªÊñπÊ≥ï
                const centerX = food.x + gridSize;
                const centerY = food.y + gridSize;

                const gradient = ctx.createRadialGradient(
                    centerX, centerY, 5,
                    centerX, centerY, gridSize
                );
                gradient.addColorStop(0, '#ffff99');
                gradient.addColorStop(0.5, '#ffd700');
                gradient.addColorStop(1, '#b8860b');
                ctx.fillStyle = gradient;

                ctx.beginPath();
                ctx.arc(centerX, centerY, gridSize - 4, 0, Math.PI * 2);
                ctx.fill();

                // Êòü„ÅÆÊ®°Êßò
                ctx.fillStyle = '#fff';
                ctx.font = `${gridSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('‚òÖ', centerX, centerY);

                // Ëºù„Åç„Ç®„Éï„Çß„ÇØ„Éà
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.ellipse(centerX - 5, centerY - 5, 3, 6, -Math.PI / 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // „Çä„Çì„ÅîÊèèÁîª
        function drawApple(x, y, radius) {
            const gradient = ctx.createRadialGradient(x, y, 2, x, y, radius);
            gradient.addColorStop(0, '#ff6666');
            gradient.addColorStop(0.7, '#ff0000');
            gradient.addColorStop(1, '#cc0000');
            ctx.fillStyle = gradient;

            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();

            // Ëëâ„Å£„Å±
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.ellipse(x + 3, y - radius + 2, 2, 4, Math.PI / 6, 0, Math.PI * 2);
            ctx.fill();
        }

        // „Éê„Éä„ÉäÊèèÁîª
        function drawBanana(x, y, radius) {
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.ellipse(x, y, radius - 2, radius, Math.PI / 4, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#ffcc00';
            ctx.beginPath();
            ctx.ellipse(x - 2, y, radius - 4, radius - 2, Math.PI / 4, 0, Math.PI * 2);
            ctx.fill();
        }

        // „Å∂„Å©„ÅÜÊèèÁîª
        function drawGrape(x, y, radius) {
            const grapeColor = '#800080';
            ctx.fillStyle = grapeColor;

            // Ë§áÊï∞„ÅÆÂ∞è„Åï„Å™ÂÜÜ„Åß„Å∂„Å©„ÅÜ„ÇíË°®Áèæ
            const positions = [
                { dx: 0, dy: -3 },
                { dx: -3, dy: 0 },
                { dx: 3, dy: 0 },
                { dx: 0, dy: 3 }
            ];

            positions.forEach(pos => {
                ctx.beginPath();
                ctx.arc(x + pos.dx, y + pos.dy, radius / 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // „ÅÑ„Å°„ÅîÊèèÁîª
        function drawStrawberry(x, y, radius) {
            const gradient = ctx.createRadialGradient(x, y, 2, x, y, radius);
            gradient.addColorStop(0, '#ff69b4');
            gradient.addColorStop(1, '#dc143c');
            ctx.fillStyle = gradient;

            ctx.beginPath();
            ctx.ellipse(x, y + 1, radius - 1, radius, 0, 0, Math.PI * 2);
            ctx.fill();

            // Ëëâ„Å£„Å±
            ctx.fillStyle = '#32cd32';
            ctx.beginPath();
            ctx.ellipse(x, y - radius + 2, radius / 2, 3, 0, 0, Math.PI * 2);
            ctx.fill();

            // Á®Æ
            ctx.fillStyle = '#ffff00';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(x - 2 + i * 2, y + 2, 1, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('length').textContent = snake.length;
            document.getElementById('bonusCount').textContent = bonusCount;

            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊúÄÈ´òË®òÈå≤Êõ¥Êñ∞
            if (score > sessionHighScore) {
                sessionHighScore = score;
                sessionHighLength = snake.length;
                sessionHighBonus = bonusCount;
                document.getElementById('sessionHigh').textContent = sessionHighScore;
                document.getElementById('sessionLength').textContent = sessionHighLength;
                document.getElementById('sessionBonus').textContent = sessionHighBonus;
            }
        }

        // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
        function gameOver() {
            gameRunning = false;
            clearInterval(gameLoop);

            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';

            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalLength').textContent = snake.length;
            document.getElementById('finalBonus').textContent = bonusCount;
            document.getElementById('gameOver').style.display = 'block';

            // „Éè„Ç§„Çπ„Ç≥„Ç¢Êõ¥Êñ∞
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                document.getElementById('highScore').textContent = highScore;
            }
        }

        // „Ç≠„ÉºÂÖ•ÂäõÂá¶ÁêÜÔºà„Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢Âº∑ÂåñÔºâ
        function handleKeyPress(event) {
            // ÊñπÂêë„Ç≠„Éº„ÇÑWASD„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÂÆåÂÖ®„Å´Èò≤„Åê
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'W', 'a', 'A', 's', 'S', 'd', 'D'].includes(event.key)) {
                event.preventDefault();
                event.stopPropagation();
            }

            if (!gameRunning || isPaused) return;

            switch (event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (direction.y === 0) direction = { x: 0, y: -gridSize };
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (direction.y === 0) direction = { x: 0, y: gridSize };
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (direction.x === 0) direction = { x: -gridSize, y: 0 };
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (direction.x === 0) direction = { x: gridSize, y: 0 };
                    break;
            }
        }

        // „É¢„Éê„Ç§„É´Áî®ÊñπÂêëÂ§âÊõ¥
        function changeDirection(dir) {
            if (!gameRunning || isPaused) return;

            switch (dir) {
                case 'UP':
                    if (direction.y === 0) direction = { x: 0, y: -gridSize };
                    break;
                case 'DOWN':
                    if (direction.y === 0) direction = { x: 0, y: gridSize };
                    break;
                case 'LEFT':
                    if (direction.x === 0) direction = { x: -gridSize, y: 0 };
                    break;
                case 'RIGHT':
                    if (direction.x === 0) direction = { x: gridSize, y: 0 };
                    break;
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        window.addEventListener('load', init);

        // Canvas Rounded Rectangle polyfill for older browsers
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }
    </script>
</body>

</html>
