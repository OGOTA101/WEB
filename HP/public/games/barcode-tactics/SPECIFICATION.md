# 📱 Bar-Code Tactics: 凸（TOTSU）Web - 仕様書

## 1. 概要

### 1.1 ゲームコンセプト
身の回りの商品のバーコード/QRコードをスキャンして「軍隊」を生成し、戦わせるリアルタイム戦術シミュレーションゲーム。
「信長の野望」の戦術パートを抜き出したような戦闘システムと、「バーコードバトラー」のワクワク感を融合。
ユニットは全て「凸」という記号だけで表現するミニマルなビジュアルが特徴。

### 1.2 ゲームの特徴
- **バーコード/QR生成**: 商品のコードをスキャンして軍隊を生成
- **再現性保証**: 同じコードからは世界中どこでも同じ能力の軍隊が生成される
- **4部隊デッキ**: 手持ちから4つを選んで戦場へ
- **リアルタイム戦術**: タップで指示を出し、凸の軍勢を操る
- **シングル＆マルチ対応**: 一人でもフレンドとも遊べる

### 1.3 プラットフォーム
| 項目 | 詳細 |
|------|------|
| 対応ブラウザ | Chrome, Firefox, Edge, Safari（モバイル対応） |
| 対応デバイス | スマートフォン（縦持ち推奨）、タブレット、PC |
| 通信 | WebSocket (Socket.io) / Firebase Realtime Database（マルチプレイ時） |
| ホスティング | Firebase Hosting |
| カメラ機能 | html5-qrcode.js ライブラリ（HTTPSが必須） |

---

## 2. 世界観・ストーリー

### 2.1 設定
「凸（トツ）」——それは古代から戦場を象徴してきた記号。
プレイヤーは「凸令官（とつれいかん）」となり、身の回りに眠る「商品の魂」を呼び覚まし、凸の軍勢として戦場に送り込む。
敵は同じく凸を操る別の令官。先に相手の全軍を壊滅させた者が勝利する！

### 2.2 コア体験
- **発見**: 「このジュースのバーコード、すごく強い軍隊になった！」
- **共有**: 「あの商品のバーコードがヤバいらしい」とSNSで話題に
- **戦術**: 少数精鋭 vs 数の暴力、遠距離 vs 騎馬の駆け引き

---

## 3. バーコード/QR 生成システム

### 3.1 再現性の確保（最重要仕様）
**「同じコード＝世界中どこで誰が読み込んでも同じ軍隊」** を保証するため、以下のアルゴリズムを採用。

```
入力（文字列）→ ハッシュ変換（SHA-256等）→ シード値（数値）→ 疑似乱数生成（Xorshift）→ パラメータ決定
```

| ステップ | 処理内容 |
|---------|---------|
| 1. 入力 | バーコード数字列 or QRのテキストデータ |
| 2. ハッシュ | SHA-256で固定長のハッシュ値に変換 |
| 3. シード化 | ハッシュ値を整数に変換（上位32bit等） |
| 4. PRNG | Xorshift等でシードから乱数列を生成 |
| 5. 抽選 | 乱数を使って合計pt、各ステータスを決定 |

**重要**: Math.random() は使用禁止。シード付き乱数ライブラリ（seedrandom.js等）を使用すること。

### 3.2 命名ルール

| 読み取りデータ | 処理 | 例 |
|---------------|------|-----|
| QR（日本語含む） | そのまま軍隊名として採用 | 「田中太郎」→「田中太郎軍」 |
| QR（URL等） | 名前入力モードへ | 入力 or 自動生成 |
| バーコード | 名前入力モードへ | 入力 or 自動生成 |

**自動生成名のパターン**:
- デフォルト: 「第[数字下4桁]部隊」（例：第4901部隊）
- 「おまかせ」: ランダム漢字2文字＋軍（例：「疾風軍」「鉄壁軍」「紅蓮軍」）

**命名用漢字プール（例）**:
```
疾, 風, 鉄, 壁, 紅, 蓮, 雷, 神, 影, 龍, 鬼, 武, 聖, 覇, 剣, 盾, 炎, 氷, 光, 闇
```

### 3.3 総合パラメータ（コスト）設定

| 軍隊の種類 | 総合ポイント (Total Cost) | バランスの位置づけ |
|-----------|--------------------------|-------------------|
| **デフォルト軍** | **2,500 pt（固定）** | 【基準】ゲーム開始時に所持。最低保証の強さ |
| **スキャン軍** | **2,500〜5,000 pt（変動）** | 【強化〜最強】運が良ければデフォルトの2倍の戦力 |

### 3.4 スキャン軍のコスト抽選（レアリティ）

単純な均等ランダムではなく、高コストほど出にくい確率分布を採用。

| レアリティ | 範囲 | 出現率 | 演出 |
|-----------|------|-------|------|
| 並 (Normal) | 2,500〜3,000 pt | 40% | 通常エフェクト |
| 良 (Rare) | 3,001〜4,000 pt | 40% | 青いオーラ |
| 激強 (Super Rare) | 4,001〜4,800 pt | 15% | 紫のオーラ＋効果音 |
| 神 (Legend) | 4,801〜5,000 pt | 5% | 金色演出＋ファンファーレ |

---

## 4. ユニットパラメータ詳細

### 4.1 ステータス定義

| パラメータ名 | 略称 | 意味 | 役割 |
|-------------|------|------|------|
| 兵力 (Count/HP) | HP | 人数・体力 | 0になると部隊消滅。戦闘で減少する |
| 攻撃 (Attack) | ATK | 攻撃力 | 敵兵力を削る速度 |
| 防御 (Defense) | DEF | 防御力 | 被ダメージの軽減値 |
| 射程 (Range) | RNG | 攻撃範囲 | 1=近接、2〜5=遠距離 |
| 機動 (Speed) | SPD | 移動速度 | 接敵までの時間、追撃能力 |

### 4.2 パラメータ分配ロジック

総合ポイントを「兵力」と「個体性能」にトレードオフで割り振る。

```javascript
// 疑似コード
function generateUnit(seed) {
    const rng = new SeededRandom(seed);
    
    // 1. 総合コスト決定（2500〜5000）
    const totalCost = determineTotalCost(rng);
    
    // 2. 兵力の決定
    const minHP = 100;
    const maxHP = Math.floor(totalCost * 0.8);
    const hp = rng.range(minHP, maxHP);
    
    // 3. 残りポイント
    const restPoints = totalCost - hp;
    
    // 4. 単体性能係数
    const unitPower = restPoints / hp;
    
    // 5. 各ステータスに分配（重み付きランダム）
    const weights = rng.randomWeights(4); // ATK, DEF, RNG, SPD
    const stats = distributeByWeight(restPoints, weights);
    
    return { hp, atk: stats[0], def: stats[1], rng: stats[2], spd: stats[3] };
}
```

### 4.3 生成例

| 名前 | 合計pt | 兵力 | ATK | DEF | RNG | SPD | 特徴 |
|------|-------|------|-----|-----|-----|-----|------|
| ポテチ軍 | 2600 | 2000 | 2 | 1 | 1 | 2 | 雑兵の壁。足止め役 |
| コーラ軍 | 3500 | 800 | 25 | 15 | 1 | 10 | バランス型の主力 |
| ウイスキー軍 | 4500 | 100 | 80 | 50 | 1 | 5 | 少数精鋭の無双部隊 |
| 洗剤軍 | 3000 | 500 | 20 | 5 | 5 | 3 | 遠距離砲撃部隊 |
| 謎のQR軍 | 5000 | 50 | 99 | 80 | 1 | 15 | 伝説級。ほぼ無敵 |

### 4.4 パラメータキャップ（バランス崩壊対策）

極端な生成を防ぐための上限・下限を設定。

| ステータス | 最小値 | 最大値 | 備考 |
|-----------|-------|-------|------|
| 兵力 (HP) | 50 | 4000 | あまりに少ないと事故死、多すぎると壁すぎる |
| 攻撃 (ATK) | 1 | 100 | 100で「無双」状態 |
| 防御 (DEF) | 0 | 80 | 80で大半の攻撃を無効化 |
| 射程 (RNG) | 1 | 5 | 1=近接、5=画面の半分 |
| 機動 (SPD) | 1 | 20 | 20で超高速移動 |

---

## 5. ユニットクラス（兵種）システム

### 5.1 クラス判定ロジック

生成されたパラメータの傾向によって自動的に「クラス」が付与される。

| クラス記号 | 名称 | 判定条件 |
|-----------|------|---------|
| **歩** | 歩兵 (Infantry) | どのステータスも突出していない（バランス型） |
| **騎** | 騎馬 (Cavalry) | SPD が最大かつ 10以上 |
| **盾** | 重装 (Tank) | DEF が最大かつ 30以上、かつ SPD が 5以下 |
| **弓** | 遠距離 (Range) | RNG が 2以上 |
| **忍** | 特殊 (Special) | ATK が最大かつ 50以上、DEF が 20以下 |

### 5.2 クラス相性（じゃんけん要素）

```
      騎馬 ──(有利)───▶ 遠距離
       ▲                  │
       │                  │
    (有利)             (有利)
       │                  │
       │                  ▼
     歩兵 ◀──(有利)─── 重装

       忍（特殊）：全てに対して攻撃的有利、守備的不利
```

| 攻撃側 | 有利な相手 | 不利な相手 | 説明 |
|-------|-----------|-----------|------|
| 騎馬 | 遠距離 | 重装 | 遠距離に急接近して倒す。盾に止められる |
| 遠距離 | 重装 | 騎馬 | 遅い盾を一方的に撃つ。騎馬に接近されると即死 |
| 重装 | 騎馬 | 遠距離 | 騎馬の突撃を受け止める。遠距離に削られる |
| 忍 | 全て（攻撃時） | 全て（防御時） | 紙装甲だが圧倒的攻撃力 |
| 歩兵 | なし | なし | 基本。万能だが決め手に欠ける |

### 5.3 ビジュアル表現

| クラス | 色 | 表示 | 補足 |
|--------|-----|------|------|
| 歩兵 | 白/黒 | **凸** | 基本形 |
| 騎馬 | 青 | **凸̲** (下線付き) | 機動力を表現 |
| 重装 | 黄 | **回** | 四角い外枠で堅牢さを表現 |
| 遠距離 | 赤 | **凸→** | 矢印で射程を表現 |
| 忍 | 紫 | **凵** | 逆凸で特殊性を表現 |

---

## 6. デッキ編成システム

### 6.1 デフォルト軍（初期所持）

ゲーム開始時に4つの軍隊を所持。これでまず遊べる最低保証。

| スロット | 名前 | 合計pt | 傾向 | クラス |
|---------|------|-------|------|-------|
| 1 | 赤の軍 | 2500 | ATKやや高め | 歩兵 |
| 2 | 青の軍 | 2500 | SPDやや高め | 騎馬 |
| 3 | 緑の軍 | 2500 | DEFやや高め | 重装 |
| 4 | 黄の軍 | 2500 | RNGやや高め | 遠距離 |

### 6.2 ストック管理

スキャンして保存した軍隊は「ストック」に蓄積される。

| 項目 | 仕様 |
|------|------|
| ストック上限 | 50体 |
| 削除 | いつでも可能（確認ダイアログあり） |
| 重複 | 同じバーコードを2回読んでも1体のみ保存 |

### 6.3 デッキ枠

戦場に連れて行く**4部隊**を選抜。

```
┌─────────────────────────────────────────────┐
│           📋 デッキ編成                      │
├─────────────────────────────────────────────┤
│                                             │
│   【出撃デッキ】                             │
│   ┌────┐ ┌────┐ ┌────┐ ┌────┐             │
│   │ 1  │ │ 2  │ │ 3  │ │ 4  │             │
│   │コーラ│ │ポテチ│ │洗剤 │ │ QR │             │
│   │3500│ │2600│ │3000│ │5000│             │
│   └────┘ └────┘ └────┘ └────┘             │
│                                             │
│   【ストック一覧】                            │
│   ┌────────────────────────────────┐        │
│   │ 赤の軍 2500 | 青の軍 2500 | ... │        │
│   │ 新軍A 3200 | 新軍B 4100 | ...  │        │
│   └────────────────────────────────┘        │
│                                             │
│   [オート編成]  [スキャンして追加]            │
└─────────────────────────────────────────────┘
```

### 6.4 編成操作

| 操作 | 方法 |
|------|------|
| デッキにセット | ストックからドラッグして枠にドロップ |
| 入れ替え | デッキ内の2つをタップして交換 |
| オート編成 | 合計ptが高い順に上位4体を自動セット |
| 詳細確認 | 長押しでステータス詳細ポップアップ |

---

## 7. 戦闘システム

### 7.1 基本ルール

| 項目 | 内容 |
|------|------|
| 勝利条件 | 敵全部隊の兵力を0にする |
| 敗北条件 | 味方全部隊の兵力を0にする |
| フィールド | 縦長。手前が自陣、奥が敵陣 |
| 時間制限 | なし（決着がつくまで永続） |

### 7.2 出撃システム

全軍一斉出撃ではなく、**コスト制**による段階的出撃を採用。

| 項目 | 仕様 |
|------|------|
| 指揮コスト | 1秒に1ポイント溜まる。最大10。戦闘開始時5。 |
| 出撃コスト | 部隊の強さに応じて消費（後述） |
| 同時出撃上限 | 戦場に同時に存在できるのは最大3部隊 |

#### 出撃コスト計算

```javascript
// 総合pt から 出撃コスト を算出
function getDeployCost(totalPoints) {
    if (totalPoints <= 2500) return 3;      // デフォルト軍クラス
    if (totalPoints <= 3500) return 4;      // 良クラス
    if (totalPoints <= 4500) return 6;      // 激強クラス
    return 8;                               // 神クラス
}
```

| 総合pt範囲 | 出撃コスト | 戦略的意味 |
|-----------|-----------|-----------|
| 〜2500 | 3 | 安い。回転率で勝負 |
| 2501〜3500 | 4 | 標準的 |
| 3501〜4500 | 6 | 強いが出し渋りが必要 |
| 4501〜5000 | 8 | 切り札。タイミング勝負 |

### 7.3 画面構成（縦持ち）

```
┌─────────────────────────────────────────────┐
│ [相手名]           残り: 2/4部隊            │
├─────────────────────────────────────────────┤
│                                             │
│        ▼ 敵陣（敵の凸が手前へ進軍）         │
│                                             │
│   凸   凸       凸凸凸                      │
│   凸   凸         凸                        │
│                                             │
│ ─ ─ ─ ─ ─ ─ 中央ライン ─ ─ ─ ─ ─ ─        │
│                                             │
│           凸凸                              │
│           凸凸  ← 選択中（光る枠）          │
│                                             │
│        ▲ 自陣（味方の凸を操作）             │
│                                             │
├─────────────────────────────────────────────┤
│  コスト: ████████░░ 8/10                    │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐             │
│  │出撃│ │出撃│ │ 済 │ │ 済 │             │
│  │ 4  │ │ 6  │ │    │ │    │             │
│  └────┘ └────┘ └────┘ └────┘             │
│  [ ⏸ 一時停止 ]    [ 🏳 降参 ]              │
└─────────────────────────────────────────────┘
```

### 7.4 操作方法

| 操作 | 方法 | 効果 |
|------|------|------|
| 選択 | 味方の凸をタップ | その部隊を選択状態に |
| 移動 | 選択後、地面をタップ | その地点へ移動（青い矢印表示） |
| 攻撃 | 選択後、敵をタップ | その敵を追尾して攻撃 |
| 出撃 | 下部スロットをタップ | コスト消費して出撃（自陣内のタップ位置に配置） |
| 一時停止 | ボタンタップ | 戦闘一時停止（シングルプレイのみ） |

### 7.5 ダメージ計算式

「少数精鋭 vs 数の暴力」を成立させる減算方式。

```javascript
// 1秒ごとに判定
function calculateDamage(attacker, defender) {
    let baseDamage = attacker.atk - defender.def;
    
    // 最低保証ダメージ（防御が高くても削れる）
    if (baseDamage < 1) baseDamage = 1;
    
    // ランダム幅（±20%）
    const variance = 0.8 + Math.random() * 0.4;
    let damage = Math.floor(baseDamage * variance);
    
    // クラス相性ボーナス（有利なら1.5倍）
    if (hasAdvantage(attacker.class, defender.class)) {
        damage = Math.floor(damage * 1.5);
    }
    
    // 兵力に加算（兵力がHPの役割）
    defender.hp -= damage;
    
    return damage;
}
```

### 7.6 射程と攻撃頻度

| 射程 (RNG) | 攻撃可能距離 | 攻撃間隔 |
|-----------|-------------|---------|
| 1 | 接触時のみ | 1.0秒 |
| 2 | 近距離 | 1.5秒 |
| 3 | 中距離 | 2.0秒 |
| 4 | 遠距離 | 2.5秒 |
| 5 | 超遠距離 | 3.0秒 |

**設計意図**: 遠距離は一方的に攻撃できるが、DPSは近接より低い。

### 7.7 ユニットサイズ（衝突半径）

少数精鋭 vs 多数の差別化。

| 兵力 | 衝突半径 | 効果 |
|------|---------|------|
| 50〜500 | 小 | 狭い隙間を抜けられる、範囲攻撃を受けにくい |
| 501〜1500 | 中 | 標準 |
| 1501〜4000 | 大 | 敵の進行を物理的に塞ぐ「壁」になれる |

---

## 8. ビジュアル仕様

### 8.1 ユニット表現「4つの凸」

1つの軍隊は画面上で**4つの小さな「凸」の集合体**として描画。

```
   凸 凸       ← HP 100%〜76%: 4体表示
   凸 凸
```

#### HP連動表示

| 兵力割合 | 表示 | 外見 |
|---------|------|------|
| 100%〜76% | 4体 | 凸凸 / 凸凸 |
| 75%〜51% | 3体 | 凸凸 / 凸 |
| 50%〜26% | 2体 | 凸 / 凸 |
| 25%〜1% | 1体 | 凸 |
| 0% | 消滅 | ✕（残骸マーク） |

### 8.2 敵味方識別

| 陣営 | 色 | 進行方向 |
|------|-----|---------|
| 味方（自分） | 青系 | 下から上へ |
| 敵（相手） | 赤系 | 上から下へ |

### 8.3 UI表示

- **ユニット頭上**: 軍隊名（小さく）+ 兵力ゲージ
- **選択中**: 周囲に光る枠
- **移動中**: 点線で目的地を表示
- **攻撃中**: 攻撃エフェクト（光線/斬撃）

### 8.4 カラーパレット

#### 戦場（和風・古地図風）

| 名前 | 色コード | 用途 |
|------|---------|------|
| 羊皮紙 | #F5E6D3 | 背景ベース |
| 墨茶 | #4A3728 | 枠線、テキスト |
| 朱赤 | #C73E3A | 敵ユニット |
| 藍青 | #3A5DAE | 味方ユニット |
| 金茶 | #D4A853 | レアリティ演出 |

### 8.5 エフェクト

| シーン | エフェクト |
|-------|-----------|
| 出撃時 | 煙幕エフェクト＋配置音 |
| ダメージ時 | 数字ポップアップ（赤） |
| 撃破時 | 「✕」マーク＋消滅アニメ |
| 勝利時 | 「WIN」大文字＋金色エフェクト |
| 敗北時 | 「LOSE」＋画面暗転 |

---

## 9. ゲームモード

### 9.1 シングルプレイ：天下統一モード

一人で遊ぶモード。CPUと戦い、ステージを攻略。

#### ステージ構成

| ステージ | 名前 | 敵編成 | 解放条件 |
|---------|------|-------|---------|
| 1 | 初陣の野 | 1,500pt × 2 | 最初から |
| 2 | 平原の戦い | 2,000pt × 2 | Lv1クリア |
| 3 | 山道の伏兵 | 2,000pt × 3 | Lv2クリア |
| 4 | 川辺の攻防 | 2,500pt × 3 | Lv3クリア |
| 5 | 城門突破戦 | 2,500pt × 4 | Lv4クリア |
| 6 | 激戦の荒野 | 3,000pt × 3 | Lv5クリア |
| 7 | 騎馬軍団 | 3,500pt × 3 (騎馬系) | Lv6クリア |
| 8 | 鉄壁の陣 | 4,000pt × 3 (重装系) | Lv7クリア |
| 9 | 弓兵の嵐 | 3,500pt × 4 (遠距離系) | Lv8クリア |
| 10 | 魔王の城 | 5,000pt × 4 | Lv9クリア |

#### CPU AI ロジック

| レベル | 行動パターン |
|-------|-------------|
| 1-3 | 直進のみ。一番近い敵に突撃 |
| 4-6 | 遠距離は後退しながら攻撃 |
| 7-9 | 騎馬で遠距離を狙う。壁役を前に出す |
| 10 | 全ての戦術を駆使。コスト管理も最適化 |

### 9.2 マルチプレイ：対戦モード

フレンドとリアルタイム対戦。

#### ルームシステム

| 項目 | 仕様 |
|------|------|
| 方式 | ルームID（4桁数字） |
| 作成 | 「部屋を作る」→ ID表示 |
| 参加 | 「部屋に入る」→ ID入力 |
| タイムアウト | 5分間マッチングなしで自動解散 |

#### 通信仕様

| データ | 送受信内容 |
|-------|-----------|
| 軍隊情報 | シード文字列のみ（相手側で再生成） |
| 位置情報 | { unitId, x, y } を毎フレーム |
| 攻撃命令 | { attackerId, targetId } |
| HP同期 | 1秒ごとにHP値をハッシュ照合 |

#### 同期方式

- **ロックステップ**: 両端末で同じ計算を行い、結果を照合
- **コマンド送信**: 「命令」のみを送り、シミュレーションは各端末
- **補正**: HPズレが検出されたらホスト側に合わせる

---

## 10. データ構造

### 10.1 LocalStorage スキーマ

```json
{
  "barcode_tactics_v1": {
    "user_id": "uuid_v4_generated",
    "deck": ["id_001", "id_002", "id_003", "id_004"],
    "stock": [
      {
        "id": "hash_of_seed",
        "seed": "4901234567890",
        "name": "第4901部隊",
        "customName": "ポテチ軍",
        "totalCost": 2600,
        "stats": {
          "hp": 2000,
          "atk": 2,
          "def": 1,
          "rng": 1,
          "spd": 2
        },
        "class": "infantry",
        "isDefault": false,
        "createdAt": "2026-01-27T00:00:00Z"
      },
      {
        "id": "default_red",
        "seed": "default_red_seed",
        "name": "赤の軍",
        "customName": null,
        "totalCost": 2500,
        "stats": { "hp": 1500, "atk": 8, "def": 5, "rng": 1, "spd": 5 },
        "class": "infantry",
        "isDefault": true
      }
    ],
    "progress": {
      "campaignLevel": 3,
      "clearedStages": [1, 2, 3]
    },
    "settings": {
      "bgmVolume": 0.5,
      "seVolume": 0.8
    }
  }
}
```

### 10.2 Firebase Realtime Database 構造（マルチプレイ）

```json
{
  "rooms": {
    "1234": {
      "state": "battle",
      "createdAt": 1706345678000,
      "host": "user_abc123",
      "guest": "user_def456",
      "players": {
        "user_abc123": {
          "name": "プレイヤー1",
          "deck": ["seed1", "seed2", "seed3", "seed4"],
          "ready": true
        },
        "user_def456": {
          "name": "プレイヤー2",
          "deck": ["seedA", "seedB", "seedC", "seedD"],
          "ready": true
        }
      },
      "battle": {
        "turn": 45,
        "cost": {
          "user_abc123": 7,
          "user_def456": 5
        },
        "units": {
          "unit_001": {
            "owner": "user_abc123",
            "seed": "seed1",
            "position": { "x": 150, "y": 400 },
            "hp": 1200,
            "target": "unit_003"
          }
        }
      }
    }
  }
}
```

---

## 11. 画面フロー

```
┌─────────────────────────────────────────────┐
│                 タイトル画面                 │
│                                             │
│           Bar-Code Tactics                  │
│               凸（TOTSU）                   │
│                                             │
│          [ 天下統一 (1人用) ]               │
│          [ 対戦 (2人用) ]                   │
│          [ 編成 ]                           │
│          [ スキャン ]                       │
│                                             │
└────────────────┬────────────────────────────┘
                 │
    ┌────────────┼────────────┐
    ▼            ▼            ▼
┌────────┐ ┌────────────┐ ┌────────────┐
│スキャン │ │  編成画面   │ │ステージ選択│
│  画面  │ │            │ │（1人用）   │
└───┬────┘ └─────┬──────┘ └─────┬──────┘
    │            │              │
    ▼            └──────────────┴──▶ バトル画面
ストックに保存                        │
                                      ▼
                                ┌──────────┐
                                │ リザルト  │
                                └──────────┘
```

---

## 12. 技術実装詳細

### 12.1 使用ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| html5-qrcode | 2.3.x | バーコード/QRスキャン |
| seedrandom | 3.0.x | シード付き乱数生成 |
| Firebase SDK | 10.x | マルチプレイ通信 |
| (Canvas API) | 組み込み | 描画エンジン |

### 12.2 ファイル構成

```
barcode-tactics/
├── index.html              # エントリーポイント
├── style.css               # グローバルスタイル
├── package.json            # 依存関係
├── firebase.json           # Firebaseホスティング設定
├── .firebaserc             # Firebaseプロジェクト設定
├── database.rules.json     # Firebase Realtime Database ルール
├── SPECIFICATION.md        # 本仕様書
│
├── js/
│   ├── main.js             # アプリケーションエントリー
│   ├── config.js           # ゲーム設定値
│   ├── scanner.js          # バーコード/QRスキャン処理
│   ├── generator.js        # ユニット生成ロジック（シード付き乱数）
│   ├── deck.js             # デッキ・ストック管理
│   ├── battle.js           # 戦闘システム
│   ├── ai.js               # CPU AI
│   ├── multiplayer.js      # マルチプレイ通信
│   ├── renderer.js         # Canvas描画
│   └── storage.js          # LocalStorage管理
│
├── assets/
│   ├── images/             # 画像素材
│   │   ├── title_logo.png
│   │   ├── bg_battlefield.png
│   │   └── effects/
│   └── audio/              # 効果音・BGM
│       ├── bgm_battle.mp3
│       ├── se_deploy.mp3
│       └── se_hit.mp3
│
└── lib/
    ├── html5-qrcode.min.js
    └── seedrandom.min.js
```

### 12.3 カメラ権限対応

```javascript
// HTTPSが必須。httpだとカメラにアクセスできない
async function startScanner() {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        alert('カメラ機能にはHTTPS接続が必要です');
        return;
    }
    
    const html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
    );
}
```

---

## 13. サウンド設計

### 13.1 BGM

| 場面 | 説明 |
|------|------|
| タイトル | 荘厳な和風オーケストラ |
| 編成 | 落ち着いた琴と笛 |
| バトル | 緊迫した太鼓と弦楽 |
| 勝利 | 勝ち鬨のファンファーレ |
| 敗北 | 哀愁のある笛のメロディ |

### 13.2 効果音

| アクション | 説明 |
|-----------|------|
| スキャン成功 | キラーン（高音） |
| レア出現 | ドラムロール＋ジャーン |
| 出撃 | ドドンッ（太鼓） |
| 移動 | サササッ（足音） |
| 攻撃（近接） | ザシュッ（斬撃） |
| 攻撃（遠距離） | ヒュン→ドスッ |
| ダメージ | パシッ |
| 撃破 | ボンッ（破裂） |
| UI選択 | カチッ |

---

## 14. 開発ロードマップ

### Phase 1: 基盤構築
- [ ] プロジェクトセットアップ
- [ ] シード付き乱数によるユニット生成
- [ ] LocalStorageでのデータ永続化
- [ ] デフォルト軍の初期データ作成

### Phase 2: スキャン機能
- [ ] html5-qrcodeの統合
- [ ] バーコード/QR読み取り
- [ ] 命名フロー実装
- [ ] 生成演出（レアリティ別）

### Phase 3: 編成画面
- [ ] ストック一覧表示
- [ ] デッキ枠へのドラッグ&ドロップ
- [ ] ステータス詳細ポップアップ

### Phase 4: バトルシステム
- [ ] Canvas戦場描画
- [ ] ユニット移動/攻撃
- [ ] コスト制出撃
- [ ] ダメージ計算/撃破判定

### Phase 5: シングルプレイ
- [ ] CPU AIの実装
- [ ] ステージ進行/解放システム

### Phase 6: マルチプレイ
- [ ] Firebase連携
- [ ] ルーム作成/参加
- [ ] リアルタイム同期

### Phase 7: 仕上げ
- [ ] BGM/効果音統合
- [ ] エフェクト追加
- [ ] UI/UXポリッシュ
- [ ] テストプレイ＆バランス調整
- [ ] デプロイ

---

## 15. バランス調整ガイド

### 15.1 調整が必要な場合のチェックポイント

| 問題 | 調整方法 |
|------|---------|
| 少数精鋭が強すぎる | DEFの最大値を下げる / 最低保証ダメージを上げる |
| 数の暴力が強すぎる | 高HP時のATK上限を下げる / 衝突サイズを上げて動きにくくする |
| 遠距離が強すぎる | 射程の攻撃間隔を伸ばす / 騎馬の速度をさらに上げる |
| 相性が効きすぎる | 倍率を1.5→1.2に下げる |
| レジェンドが壊れ | 5000ptの出現率をさらに下げる（1%等） |

### 15.2 テストプレイ推奨パターン

1. デフォルト軍同士の対戦（基準確認）
2. デフォルト vs 3000pt軍（スキャンの優位確認）
3. 3000pt vs 5000pt（レジェンドの圧倒感確認）
4. 5000pt（少数精鋭）vs 5000pt（多人数）対決
5. 全遠距離 vs 全騎馬（相性確認）

---

## 16. SGGameSite への追加

### 追加場所
- **カテゴリ**: 戦略・シミュレーション
- **URL**: `games/barcode-tactics/`

### ゲーム一覧表示
| 項目 | 内容 |
|------|------|
| ゲーム名 | 📱 Bar-Code Tactics: 凸 |
| 説明 | バーコードやQRコードをスキャンして軍隊を生成！凸の軍勢を率いて戦うリアルタイム戦術ゲーム。シングル・対戦両対応！ |
| 人数 | 1-2人 |
| 状態 | NEW! |

---

## 17. 補足・FAQ

### Q. 同じ商品でもパッケージリニューアルでバーコードが変わったら？
A. 別の軍隊として生成されます。これは「レア商品を見つける楽しみ」として前向きに捉えてください。

### Q. 通信対戦中に片方が切断したら？
A. 30秒待機後、残った側の勝利となります。

### Q. ストックが50体を超えたら？
A. 新しいユニットを保存する際に、削除対象を選択させるダイアログを表示します。

---

*最終更新: 2026-01-27*
*バージョン: 1.0.0*
