# 🎮 3Dクレーンゲーム 仕様書

## 1. 概要

### 1.1 ゲームコンセプト
Webブラウザ上で動作する、リアルな物理演算を搭載した3Dクレーンゲーム。
複数人が同時にプレイでき、限られた資金で景品獲得を目指すゲーム性を持つ。

### 1.2 プラットフォーム
- **対応ブラウザ**: Chrome, Firefox, Edge, Safari (WebGL2対応)
- **デバイス**: PC（キーボード操作）、タブレット/スマホ（タッチ操作）
- **通信**: Firebase Realtime Database によるリアルタイム同期

---

## 2. 技術スタック

| 項目 | 技術 | 用途 |
|------|------|------|
| 3D描画 | Three.js | クレーン筐体、景品、照明の描画 |
| 物理演算 | Cannon-es | 衝突判定、重力、掴む動作 |
| マルチプレイヤー | Firebase Realtime Database | プレイヤー同期、状態共有 |
| ビルドツール | Vite | 開発環境、ホットリロード |
| ホスティング | Firebase Hosting | デプロイ |

---

## 3. ゲームシステム

### 3.1 資金システム

| 項目 | 値 |
|------|-----|
| 初期資金 | ¥2,000 |
| 1プレイ料金 | ¥100 |
| 最大プレイ可能回数（初期） | 20回 |

#### 資金の増減ルール
- **減少**: クレーンを操作開始するたびに ¥100 消費
- **増加**: 景品を排出口に落とすと、その景品の「評価額」分が資金に加算
- **ゲームオーバー条件**: 資金が ¥100 未満になった時点でゲーム終了

### 3.2 景品システム

景品にはそれぞれ「評価額」が設定されている。

| 景品タイプ | サイズ | 重さ | 評価額 | 獲得難易度 |
|-----------|--------|------|--------|-----------|
| 小さいぬいぐるみ | 小 | 軽い | ¥50 | ★☆☆ 簡単 |
| 中サイズぬいぐるみ | 中 | 普通 | ¥150 | ★★☆ 普通 |
| 大きいぬいぐるみ | 大 | 重い | ¥300 | ★★★ 難しい |
| レアフィギュア | 中 | 重い | ¥500 | ★★★ 難しい |
| 超レア景品 | 大 | 非常に重い | ¥1,000 | ★★★★ 激ムズ |

#### 景品の物理特性
- 軽い景品: 掴みやすいが、滑り落ちやすい
- 重い景品: 掴みにくいが、一度掴めば安定
- 形状による影響: 球体は転がりやすく、箱型は安定

### 3.3 クレーン機構

```
┌─────────────────────────────────┐
│         ガントリーレール         │  ← X軸移動
├─────────────────────────────────┤
│              │                  │
│         ┌────┴────┐             │  ← Z軸移動
│         │ キャリッジ │             │
│         └────┬────┘             │
│              │                  │
│         ┌────┴────┐             │  ← Y軸（上下）
│         │  アーム  │             │
│         └────┬────┘             │
│            /   \                │
│           /     \               │  ← 爪（開閉）
│          ▼       ▼              │
│     [景品] [景品] [景品]         │
└─────────────────────────────────┘
         ↓ 排出口 ↓
```

#### クレーンパラメータ
| パラメータ | 値 |
|-----------|-----|
| X軸移動範囲 | -2.0 ~ +2.0 |
| Z軸移動範囲 | -1.5 ~ +1.5 |
| 下降最大距離 | 2.5m |
| 爪の開閉角度 | 0° ~ 45° |
| 爪の握力 | 景品重量の120%まで保持可能 |
| 操作制限時間 | 30秒 |

---

## 4. マルチプレイヤーシステム

### 4.1 同期される情報

| データ | 同期タイミング | 説明 |
|--------|---------------|------|
| プレイヤー位置 | リアルタイム | 他プレイヤーのクレーン位置を表示 |
| プレイヤー状態 | 状態変化時 | 待機中/操作中/観戦中 |
| 景品位置 | 毎フレーム | 全景品の物理位置 |
| 景品獲得 | 獲得時 | 誰がどの景品を取ったか |
| チャット | 送信時 | 簡易メッセージ |

### 4.2 順番制システム

複数人が同時に操作すると混乱するため、**順番待ち制**を採用。

```
[状態遷移図]

  参加      順番が      操作開始     操作終了
   →  待機中  →  操作権取得  →  操作中  →  待機中に戻る
       ↑                              │
       └──────────────────────────────┘
```

#### ルール
1. ゲームに参加すると「待機列」に追加される
2. 待機列の先頭のプレイヤーが操作権を持つ
3. 操作権を持つプレイヤーのみがクレーンを動かせる
4. 操作終了後（景品落下 or タイムアウト）、次のプレイヤーに権利が移る
5. 他のプレイヤーは観戦モードで見ている

### 4.3 プレイヤー表示
- 各プレイヤーには固有の色が割り当てられる
- 操作中のプレイヤー名がUI上部に表示される
- 待機列のプレイヤー名がサイドバーに表示される

---

## 5. ゲームフロー

### 5.1 全体フロー

```
┌─────────────┐
│  タイトル画面  │
│  名前入力    │
└──────┬──────┘
       ↓
┌─────────────┐
│  ロビー画面   │  ← 他プレイヤー確認、準備完了
└──────┬──────┘
       ↓
┌─────────────┐
│  ゲーム画面   │  ← メインゲームループ
└──────┬──────┘
       ↓ (資金 < ¥100)
┌─────────────┐
│ ゲームオーバー │
│  結果表示    │
└─────────────┘
```

### 5.2 1プレイの流れ（操作権を持つプレイヤー）

| ステップ | 状態 | 説明 |
|---------|------|------|
| 1 | READY | 「スタート」ボタンを押す（¥100消費） |
| 2 | MOVING_XZ | 矢印キー/タップでクレーンをXZ平面で移動 |
| 3 | DROPPING | スペース/タップで降下開始（自動） |
| 4 | GRABBING | 最下点で爪が自動で閉じる |
| 5 | RISING | 自動で上昇 |
| 6 | RETURNING | 排出口上部へ自動移動 |
| 7 | RELEASING | 爪が開き、景品が落下 |
| 8 | RESULT | 獲得判定 → 資金加算（成功時） |

---

## 6. 操作方法

### 6.1 PC（キーボード）

| キー | 動作 |
|------|------|
| ↑ / W | クレーンを奥へ移動 |
| ↓ / S | クレーンを手前へ移動 |
| ← / A | クレーンを左へ移動 |
| → / D | クレーンを右へ移動 |
| Space | 降下開始 |
| Enter | ゲーム開始 / 確定 |
| Esc | メニュー表示 |

### 6.2 スマートフォン/タブレット

| 操作 | 動作 |
|------|------|
| ドラッグ | クレーンを移動（バーチャルジョイスティック） |
| タップ（ボタン） | 降下開始 |
| スワイプ | カメラ視点変更 |

---

## 7. UI/UX設計

### 7.1 画面レイアウト

```
┌────────────────────────────────────────────┐
│  [資金: ¥1,500]    [プレイ中: Player1]      │  ← ヘッダー
├──────────────────────────────┬─────────────┤
│                              │ 待機中:      │
│                              │ • Player2   │
│       [3Dゲーム画面]          │ • Player3   │
│                              │             │
│                              │ 獲得履歴:    │
│                              │ 🧸 ¥150     │
│                              │ 🎁 ¥300     │
├──────────────────────────────┴─────────────┤
│  [← 移動 →]    [▼ 降下]    [残り時間: 25秒] │  ← コントロールパネル
└────────────────────────────────────────────┘
```

### 7.2 視覚的フィードバック

| 状況 | フィードバック |
|------|--------------|
| 資金消費 | 資金表示が赤くフラッシュ |
| 景品獲得 | 紙吹雪エフェクト + 効果音 |
| 残り時間10秒以下 | タイマーが赤く点滅 |
| 他プレイヤー操作中 | クレーンが半透明で表示 |
| ゲームオーバー | 画面がグレースケールに |

---

## 8. 景品配置と補充

### 8.1 初期配置
- ゲーム開始時、15〜20個の景品がランダムに配置される
- 景品は物理演算により自然に積み重なる

### 8.2 補充ルール
- 景品数が5個以下になると、新しい景品が上から降ってくる
- 補充時はアナウンス「景品補充中！」を表示
- 補充中は全員操作不可（5秒間）

---

## 9. サウンド設計

| 状況 | サウンド |
|------|---------|
| BGM | ゲームセンター風の軽快な音楽 |
| クレーン移動 | モーター音 |
| 爪開閉 | 油圧音 |
| 景品獲得 | ファンファーレ |
| コイン投入 | チャリンという音 |
| ゲームオーバー | 残念な効果音 |

---

## 10. ファイル構成

```
crane-game/
├── index.html              # エントリーポイント
├── style.css               # グローバルスタイル
├── vite.config.js          # Viteの設定
├── package.json            # 依存関係
├── firebase.json           # Firebaseホスティング設定
├── .firebaserc             # Firebaseプロジェクト設定
│
├── src/
│   ├── main.js             # アプリケーションエントリー
│   ├── game/
│   │   ├── Game.js         # メインゲームクラス
│   │   ├── Crane.js        # クレーン制御
│   │   ├── Prize.js        # 景品クラス
│   │   ├── Physics.js      # 物理エンジン管理
│   │   └── GameState.js    # 状態管理
│   │
│   ├── multiplayer/
│   │   ├── Firebase.js     # Firebase接続
│   │   ├── Sync.js         # 同期処理
│   │   └── Queue.js        # 順番待ちキュー
│   │
│   ├── ui/
│   │   ├── HUD.js          # ヘッドアップディスプレイ
│   │   ├── Controls.js     # 操作UI
│   │   └── Lobby.js        # ロビー画面
│   │
│   └── assets/
│       ├── models/         # 3Dモデル（GLTFまたは生成）
│       ├── textures/       # テクスチャ画像
│       └── sounds/         # 効果音・BGM
│
└── public/
    └── (静的ファイル)
```

---

## 11. Firebase データ構造

```json
{
  "games": {
    "<gameId>": {
      "state": "playing",
      "currentPlayer": "player1_uid",
      "prizes": {
        "prize_001": {
          "type": "small_plush",
          "position": { "x": 0.5, "y": 0.2, "z": -0.3 },
          "rotation": { "x": 0, "y": 45, "z": 0 },
          "acquired": false
        }
      },
      "queue": ["player1_uid", "player2_uid", "player3_uid"],
      "players": {
        "player1_uid": {
          "name": "たろう",
          "balance": 1500,
          "color": "#FF5733",
          "prizes_won": 3
        }
      }
    }
  }
}
```

---

## 12. 開発ロードマップ

### Phase 1: 基盤構築（1日目）
- [x] 仕様書作成
- [ ] Viteプロジェクトセットアップ
- [ ] Three.js + Cannon-es 導入
- [ ] 基本的な3Dシーン構築

### Phase 2: クレーン実装（2日目）
- [ ] クレーン機構の3Dモデル作成
- [ ] 物理ジョイントによる爪の実装
- [ ] 操作システム

### Phase 3: ゲームロジック（3日目）
- [ ] 資金システム
- [ ] 景品クラスと獲得判定
- [ ] 状態遷移管理

### Phase 4: マルチプレイヤー（4日目）
- [ ] Firebase連携
- [ ] 順番待ちキュー
- [ ] 同期処理

### Phase 5: UI/UX・仕上げ（5日目）
- [ ] UIデザイン
- [ ] エフェクト・サウンド
- [ ] デプロイ

---

## 13. 将来的な拡張案

- **景品ガチャシステム**: 景品の種類をランダム化
- **デイリーボーナス**: ログインボーナスで初期資金増加
- **ランキングシステム**: 累計獲得金額でランキング
- **カスタムルーム**: 友達だけで遊べるプライベートルーム
- **VRモード**: WebXR対応

---

*最終更新: 2026-01-25*
*バージョン: 1.0.0*
